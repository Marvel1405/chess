<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Cyber Chess</title>
    <link rel="icon" href="./Capture.PNG" />
    <style>
      :root {
        --dark-sq: #161b22;
        --light-sq: #30363d;
        --red: #ff4444;
        --blue: #4444ff;
        --accent: #00ff41;
        --bsz: clamp(280px, 85vmin, 600px);
      }

      * {
        box-sizing: border-box;
        touch-action: manipulation;
        margin: 0;
        padding: 0;
      }

      body {
        background: #0d1117;
        color: white;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        font-family: "Segoe UI", sans-serif;
        overflow: hidden;
      }

      .ui-bar {
        width: var(--bsz);
        display: flex;
        justify-content: space-between;
        padding: 10px;
        background: #1c2128;
        border: 1px solid #333;
      }

      #board {
        display: grid;
        grid-template-columns: repeat(8, 12.5%);
        grid-template-rows: repeat(8, 12.5%);
        width: var(--bsz);
        height: var(--bsz);
        border: 4px solid #444;
        position: relative;
        background: #222;
      }

      .sq {
        width: 100%;
        height: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: calc(var(--bsz) / 10);
        cursor: pointer;
        position: relative;
      }

      .w {
        background: var(--light-sq);
      }
      .b {
        background: var(--dark-sq);
      }
      .red-p {
        color: var(--red);
      }
      .blue-p {
        color: var(--blue);
      }
      .sel {
        background: rgba(0, 255, 65, 0.3) !important;
      }
      .hint::after {
        content: "";
        width: 20%;
        height: 20%;
        background: var(--accent);
        border-radius: 50%;
        opacity: 0.5;
      }

      /* Overlays */
      #overlay,
      #promo-overlay {
        position: absolute;
        inset: 0;
        background: rgba(0, 0, 0, 0.92);
        display: none;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 100;
      }

      .promo-box {
        display: flex;
        gap: 15px;
        background: #222;
        padding: 20px;
        border: 2px solid var(--accent);
        border-radius: 10px;
      }

      .promo-choice {
        font-size: 3rem;
        cursor: pointer;
        transition: transform 0.2s;
      }
      .promo-choice:hover {
        transform: scale(1.2);
      }

      .btn {
        padding: 10px 20px;
        background: var(--accent);
        border: none;
        font-weight: bold;
        cursor: pointer;
        margin-top: 15px;
      }
      .timer {
        font-family: monospace;
        font-size: 1.2rem;
      }
    </style>
  </head>
  <body>
    <div class="ui-bar" style="border-radius: 8px 8px 0 0">
      <div id="t-red" class="timer" style="color: var(--red)">10:00</div>
      <div id="cap-red"></div>
    </div>

    <p id="status" style="color: var(--accent); margin: 5px; font-weight: bold">
      BLUE'S TURN
    </p>

    <div id="board">
      <div id="overlay">
        <h1 id="win-msg">CHECKMATE</h1>
        <button class="btn" onclick="location.reload()">REMATCH</button>
      </div>
      <div id="promo-overlay">
        <h3 style="margin-bottom: 15px">PROMOTE PAWN</h3>
        <div class="promo-box" id="promo-list"></div>
      </div>
    </div>

    <div class="ui-bar" style="border-radius: 0 0 8px 8px">
      <div id="t-blue" class="timer" style="color: var(--blue)">10:00</div>
      <div id="cap-blue"></div>
    </div>

    <script>
      const audio = new (window.AudioContext || window.webkitAudioContext)();
      function playSfx(f, d) {
        const o = audio.createOscillator(),
          g = audio.createGain();
        o.frequency.value = f;
        g.gain.exponentialRampToValueAtTime(0.0001, audio.currentTime + d);
        o.connect(g);
        g.connect(audio.destination);
        o.start();
        o.stop(audio.currentTime + d);
      }

      let board = [
        ["♜", "♞", "♝", "♛", "♚", "♝", "♞", "♜"],
        ["♙", "♙", "♙", "♙", "♙", "♙", "♙", "♙"],
        ["", "", "", "", "", "", "", ""],
        ["", "", "", "", "", "", "", ""],
        ["", "", "", "", "", "", "", ""],
        ["", "", "", "", "", "", "", ""],
        ["♟", "♟", "♟", "♟", "♟", "♟", "♟", "♟"],
        ["♖", "♘", "♗", "♕", "♔", "♗", "♘", "♖"],
      ];

      let turn = "blue",
        sel = null,
        isOver = false,
        timer = null,
        time = { blue: 600, red: 600 };
      let pendingPromo = null;

      const getT = (p) => {
        if (!p) return null;
        return "♖♘♗♕♔♟".includes(p) ? "blue" : "red";
      };

      function canM(sr, sc, er, ec, p, ignoreK = false) {
        if (sr === er && sc === ec) return false;
        let t = board[er][ec],
          dr = er - sr,
          dc = ec - sc,
          ar = Math.abs(dr),
          ac = Math.abs(dc);
        if (!ignoreK && getT(t) === getT(p)) return false;

        if (p === "♟") {
          // Blue Up
          if (dc === 0 && t === "") {
            if (dr === -1) return true;
            if (sr === 6 && dr === -2 && board[5][sc] === "") return true;
          }
          return ac === 1 && dr === -1 && getT(t) === "red";
        }
        if (p === "♙") {
          // Red Down
          if (dc === 0 && t === "") {
            if (dr === 1) return true;
            if (sr === 1 && dr === 2 && board[2][sc] === "") return true;
          }
          return ac === 1 && dr === 1 && getT(t) === "blue";
        }

        const path = () => {
          let rs = Math.sign(dr),
            cs = Math.sign(dc);
          let r = sr + rs,
            c = sc + cs;
          while (r !== er || c !== ec) {
            if (board[r][c]) return false;
            r += rs;
            c += cs;
          }
          return true;
        };

        if ("♖♜".includes(p)) return (dr === 0 || dc === 0) && path();
        if ("♗♝".includes(p)) return ar === ac && path();
        if ("♘♞".includes(p))
          return (ar === 2 && ac === 1) || (ar === 1 && ac === 2);
        if ("♕♛".includes(p))
          return (dr === 0 || dc === 0 || ar === ac) && path();
        if ("♔♚".includes(p)) return ar <= 1 && ac <= 1;
        return false;
      }

      function inCheck(col) {
        let k;
        const icon = col === "blue" ? "♔" : "♚";
        board.forEach((r, i) =>
          r.forEach((p, j) => {
            if (p === icon) k = [i, j];
          })
        );
        if (!k) return false;
        return board.some((r, i) =>
          r.some(
            (p, j) => p && getT(p) !== col && canM(i, j, k[0], k[1], p, true)
          )
        );
      }

      function isMate(col) {
        if (!inCheck(col)) return false;
        for (let r = 0; r < 8; r++)
          for (let c = 0; c < 8; c++) {
            if (getT(board[r][c]) === col) {
              for (let nr = 0; nr < 8; nr++)
                for (let nc = 0; nc < 8; nc++) {
                  if (canM(r, c, nr, nc, board[r][c])) {
                    let tmp = board[nr][nc],
                      p = board[r][c];
                    board[nr][nc] = p;
                    board[r][c] = "";
                    let safe = !inCheck(col);
                    board[r][c] = p;
                    board[nr][nc] = tmp;
                    if (safe) return false;
                  }
                }
            }
          }
        return true;
      }

      function handle(r, c) {
        if (isOver || pendingPromo) return;
        if (!timer) {
          timer = setInterval(() => {
            time[turn]--;
            let m = Math.floor(time[turn] / 60),
              s = time[turn] % 60;
            document.getElementById("t-" + turn).innerText = `${m}:${
              s < 10 ? "0" : ""
            }${s}`;
            if (time[turn] <= 0) endGame("TIME OUT!");
          }, 1000);
        }

        if (sel) {
          const p = board[sel.r][sel.c];
          if (canM(sel.r, sel.c, r, c, p)) {
            const target = board[r][c];
            board[r][c] = p;
            board[sel.r][sel.c] = "";

            if (inCheck(turn)) {
              board[sel.r][sel.c] = p;
              board[r][c] = target;
            } else {
              target ? playSfx(300, 0.2) : playSfx(600, 0.1);
              if (target)
                document.getElementById("cap-" + turn).innerHTML += target;

              // Check Promotion
              if ((p === "♟" && r === 0) || (p === "♙" && r === 7)) {
                pendingPromo = { r, c, team: turn };
                showPromoUI();
              } else {
                nextTurn();
              }
            }
          }
          sel = null;
          render();
        } else if (getT(board[r][c]) === turn) {
          sel = { r, c };
          render();
        }
      }

      function showPromoUI() {
        const overlay = document.getElementById("promo-overlay");
        const list = document.getElementById("promo-list");
        overlay.style.display = "flex";
        const pieces =
          pendingPromo.team === "blue"
            ? ["♕", "♖", "♗", "♘"]
            : ["♛", "♜", "♝", "♞"];
        list.innerHTML = pieces
          .map(
            (p) =>
              `<div class="promo-choice blue-p" onclick="promoteTo('${p}')">${p}</div>`
          )
          .join("");
      }

      function promoteTo(piece) {
        board[pendingPromo.r][pendingPromo.c] = piece;
        document.getElementById("promo-overlay").style.display = "none";
        pendingPromo = null;
        nextTurn();
        render();
      }

      function nextTurn() {
        turn = turn === "blue" ? "red" : "blue";
        document.getElementById("status").innerText =
          turn.toUpperCase() + "'S TURN";
        if (isMate(turn)) endGame("CHECKMATE!");
      }

      function endGame(m) {
        clearInterval(timer);
        isOver = true;
        document.getElementById("overlay").style.display = "flex";
        document.getElementById("win-msg").innerText = m;
      }

      function render() {
        const b = document.getElementById("board");
        b.querySelectorAll(".sq").forEach((s) => s.remove());
        board.forEach((row, r) =>
          row.forEach((p, c) => {
            const s = document.createElement("div");
            s.className = `sq ${(r + c) % 2 === 0 ? "w" : "b"}`;
            if (sel && sel.r === r && sel.c === c) s.classList.add("sel");
            if (sel && canM(sel.r, sel.c, r, c, board[sel.r][sel.c]))
              s.classList.add("hint");
            s.innerText = p;
            if (p) s.classList.add(getT(p) + "-p");
            s.onclick = () => handle(r, c);
            b.appendChild(s);
          })
        );
        b.appendChild(document.getElementById("overlay"));
        b.appendChild(document.getElementById("promo-overlay"));
      }
      render();
    </script>
  </body>
</html>
